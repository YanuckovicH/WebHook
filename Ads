// ID вашей Google таблицы
const SPREADSHEET_ID = "1otAXwjTKZHORnnhkD17erjAd171E3SxdyjWDErO3mj8";
const SHEET_NAME = "1"; // Укажите название листа

function main() {
  const allowedWords = fetchAllowedWordsFromSheet(); // Получаем список разрешенных слов
  const reviewLog = []; // Лог для слов, требующих одобрения
  
  const searchTermsReport = AdsApp.report(
    `SELECT Query, AdGroupId, CampaignId, Impressions, Clicks
     FROM SEARCH_QUERY_PERFORMANCE_REPORT
     WHERE Impressions > 0`
  );
  
  const rows = searchTermsReport.rows();
  
  while (rows.hasNext()) {
    const row = rows.next();
    const query = row['Query'];
    const adGroupId = row['AdGroupId'];
    const campaignId = row['CampaignId'];
    
    // Разложить запрос на слова
    const words = query.split(/\s+/);
    const hasAllowedWords = words.some(word => allowedWords.includes(word));
    
    // Если фраза содержит запрещенные слова, добавить в лог
    if (!hasAllowedWords) {
      reviewLog.push({
        query: query,
        adGroupId: adGroupId,
        campaignId: campaignId
      });
    }
  }
  
  // Логирование для ручного одобрения
  logReviewItems(reviewLog);
}

// Получение списка разрешенных слов из Google Sheets
function fetchAllowedWordsFromSheet() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const values = sheet.getRange("A1:A").getValues(); // Предполагается, что разрешенные слова в колонке A
  return values
    .map(row => row[0])
    .filter(word => word); // Убираем пустые строки
}

// Функция логирования
function logReviewItems(log) {
  if (log.length === 0) {
    Logger.log("No new negative keywords to review.");
    return;
  }
  
  Logger.log("The following search terms are suggested for negative keywords:");
  log.forEach(item => {
    Logger.log(`Query: "${item.query}", AdGroupId: ${item.adGroupId}, CampaignId: ${item.campaignId}`);
  });
}
